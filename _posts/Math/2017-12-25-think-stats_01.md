---
layout: post
title: ThinkStats-统计思维--01-探索性数据分析
date: 2017-12-25 01:00:00
categories: 数学
tags: Python 统计学
---
* content
{:toc}


# 1. 数据导入

下载 https://github.com/AllenDowney/ThinkStats2  中对应的包，下面是包中包含的文件：
- `code/nsfg.py` 读取文件执行测试，运行完毕后，会打印 All test passed
- `2002Fem-Preg.dat.gzm`,第六次家庭增长调查的妊娠数据，纯文本，一条记录为一次妊娠数据
- `2002FemPreg.dct`，是一个stata字典文件，记录了数据文件的格式，如下：

```python
infile dictionary {
  _column(1) str12 caseid %12s 
  "RESPONDENT ID NUMBER" 
  
  _column(13) byte pregordr %2f 
  "PREGNANCY ORDER (NUMBER)"}
```

- `thinkstats2.py`，包含很多类和函数，其中有读取Stats字典和调查数据文件的函数，这两个函数在nsfg.py中的用法如下：

```python
def ReadFemResp(dct_file='2002FemResp.dct',
                dat_file='2002FemResp.dat.gz',
                nrows=None):
    """Reads the NSFG respondent data.

    dct_file: string file name
    dat_file: string file name

    returns: DataFrame
    """
    dct = thinkstats2.ReadStataDct(dct_file)
    df = dct.ReadFixedWidth(dat_file, compression='gzip', nrows=nrows)
    CleanFemResp(df)
    return df
```
`dct_file`作为参数传递给`ReadStataDct`函数，表示字典文件名，返回值dct是一个`FixedWidthVariable`对象，dct对象提供`ReadFixdWidth`方法进行数据文件的读取。


# 2. DataFrame

DataFrame是pandas提供的一个基础数据结构，与R中的DataFrame概念一致，每个记录(一条妊娠数据)为一行，每个变量为一列。


```python
import os
os.getcwd() # 查看当前工作目录
os.chdir("C:\\Users\\hundsun\\Desktop\\lijun\\ThinkStats2-master\\code") # 改变目录，注意双引号和反斜杠
```

```python
import nsfg
df = nsfg.ReadFemPreg()
df.head()
```

![image](https://user-images.githubusercontent.com/18595935/34340643-4af8576c-e9cb-11e7-85e6-1c0f37fac46b.png)

df.columns的结果是一个Index对象，Index也是一个pandas数据结构，类似一个list


```python
df.columns
```

输出如下:

```python
    Index(['caseid', 'pregordr', 'howpreg_n', 'howpreg_p', 'moscurrp', 'nowprgdk',
           'pregend1', 'pregend2', 'nbrnaliv', 'multbrth',
           ...
           'laborfor_i', 'religion_i', 'metro_i', 'basewgt', 'adj_mod_basewgt',
           'finalwgt', 'secu_p', 'sest', 'cmintvw', 'totalwgt_lb'],
          dtype='object', length=244)
```


```python
pregordr = df["pregordr"]
pregordr.head()
```

输出如下:

```python
    0    1
    1    2
    2    1
    3    2
    4    3
    Name: pregordr, dtype: int64
```


pregordr列数据是一个Series对象，也是一个与list类似的数据结构：


```python
type(pregordr)
```



输出如下:

```python
    pandas.core.series.Series
```


因为上面的Series和Index都是类似list的数据结构，所以能够通过数字进行index或是切片。

# 3. 变量

看上面df的输出，共有244列，即244个变量，主要用的变量如下所示：
- caseid：调查参与者的整数ID。 
- prglength：妊娠周数，是一个整数。 
- outcome：怀孕结果的整数代码。1代表成功生产。 
- pregordr：妊娠的顺序号。例如，一位调查参与者的第一次妊娠为1，第二次为2，以此类推。 
- birthord：成功生产的顺序号，一位调查参与者的第一个孩子代码为1，以此类推。对没有成功生产的其他妊娠结果，此字段为空。 
- birthwgt_lb和birthwgt_oz：新生儿体重的磅部分数值和盎司部分数值。 
- agepreg：妊娠结束时母亲的年龄。 
- finalwgt：调查参与者的统计权重。这是一个浮点数，表示这位调查参与者在全美人口中代表的人数。

为了方便后续分析，有很多重编码，即通过一些逻辑计算得到的变量。


# 4. 数据变换

导入调查数据时，通常要检查数据是否有错误，处理特殊值，这些操作都称为数据清洗，nsfg.py包含一个CleanFemPreg函数，用于清洗计划使用的变量。

最后一行代码，用于新增一个列：

```python
df['totalwgt_lb'] = df.birthwgt_lb + df.birthwgt_oz / 16.0  
```

如果写成，则是给这个df对象添加一个新的属性，R中使用`df$totalwgt_lb`增加一列。

```python
df.totalwgt_lb = df.birthwgt_lb + df.birthwgt_oz / 16.0  
```

## 4.1 增加一列数据


```python
df['test1'] = 111 
df.head()
```

![image](https://user-images.githubusercontent.com/18595935/34340656-93ba1878-e9cb-11e7-8ef5-e6414dc144ea.png)


## 4.2 给df对象增加属性

这里增加的test2，类似于size


```python
df.test2 = 222
df.test2
```


```python
    222
```

```python
df.size
```


```python
    3330285
```


# 7. 数据验证

在数据数据分析之前，先对数据进行简单的验证，避免后续出错浪费时间，简单的验证就是计算基本的统计量，是否与既有数据或是常识有大的偏差。
比如outcome变量指的是妊娠结果，其概要表如下:
- 1 LIVE BIRTH
- 2 INDUCED ABORTION
- 3 STILLBIRTH
- ...

`value_counts()`可以用于计算每个值的出现次数，如下：

## 7.1 妊娠结果数据概要：

```python
df.outcome.value_counts().sort_index()
```


输出如下:

```python
    1    9148
    2    1862
    3     120
    4    1921
    5     190
    6     352
    Name: outcome, dtype: int64
```


## 7.2 新生儿体重数据概要：


```python
df.birthwgt_lb.value_counts(sort=False)
```


输出如下:

```python
    8.0     1889
    7.0     3049
    6.0     2223
    4.0      229
    5.0      697
    10.0     132
    12.0      10
    14.0       3
    3.0       98
    1.0       40
    2.0       53
    0.0        8
    9.0      623
    11.0      26
    13.0       3
    15.0       1
    Name: birthwgt_lb, dtype: int64
```


如果有异常值，可以用下面的方式将数据替换为`np.nan`,比如将体重为20磅以上的数据设为非法值：

```python
import numpy as np
df.birthwgt_lb[df.birthwgt_lb>20] = np.nan
```

# 8. 解释数据

preg_map 是将每个caseID映射到一系列索引的字典，通过下面的函数找到特定caseid的妊娠结果


```python
preg_map = nsfg.MakePregMap(df)

caseid = 10229
indices = preg_map[caseid]
df.outcome[indices].values
```



输出如下:

```python
    array([4, 4, 4, 4, 4, 4, 1], dtype=int64)
```


可以看到怀孕6次，每次都流产告终，第七次怀孕成功并生产。下面是创建字典函数的详细定义：

```python
def MakePregMap(df):
    """Make a map from caseid to list of preg indices.
    df: DataFrame
    returns: dict that maps from caseid to list of indices into `preg`
    """
    d = defaultdict(list)
    for index, caseid in df.caseid.iteritems():
        d[caseid].append(index)
    return d
```

# 9. 术语

- 轶事证据（anecdotal evidence）随意收集，而非通过精心设计的研究获得的证据，通常是个人证据。 
- 总体（population）在研究中，我们感兴趣的群组。“总体”经常指一组人，但这个词也可以用于其他对象。 
- 横截面研究（cross-sectional study）收集一个总体在某个特定时间点的数据的研究。 
- 周期（cycle）在重复进行的横截面研究中，每次研究称为一个周期。 
- 纵向研究（longtitudinal study）在一段时间内跟踪一个总体的研究，从同一个群体重复收集数据。

- 调查参与者（respondent）参与调查的人。 
- 样本（sample）总体中用于数据收集的一个子集。 
- 有代表性（representative）如果总体中的每个成员被选入样本的机会都均等，那么这个样本就是有代表性的。

- 过度抽样（oversampling）一种通过增加一个子总体的样本数来避免因样本规模过小产生错误的技术。比如，某个族裔的比重很少，如果按照这个族裔在国家的比例进行抽样的话，可能就只有5人，但是这5人的样本过小会产生错误，所以特意的扩大这个族裔的样本。
 
- 原始数据（raw data）没有经过或只经过少许检查、计算或解释，直接收集和记录的值。 
- 重编码（recode）通过计算和应用于原始数据的其他逻辑生成的值。 
- 数据清洗（data cleaning）数据处理过程，包括数据验证、错误检查，以及数据类型和表示的转换等。
