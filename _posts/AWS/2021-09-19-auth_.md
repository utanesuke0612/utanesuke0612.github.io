---
layout: post
title: 彻底理解 OAuth2 协议
date: 2021-09-19 00:01:01
categories: AWS
tags: aws
---
* content
{:toc}

> 参照：
- [彻底理解 OAuth2 协议](https://www.youtube.com/watch?v=T0h6A-M_WmI&t=47s)
- [理解OAuth 2.0](https://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html)

# 1. 概要

OAuth 2.0是一个工业级别的开发授权协议，可以使互联网用户授权第三方网站或应用访问他们在特定网站上的信息（如个人资料、照片等），而不必向第三方网站或应用提供密码。在此之前我们使用用户名和密码的方式登录到应用，聪明的互联网前辈们发明了 OAuth 授权协议提出了一个 “授权服务器”，**经过用户授权后授权服务器向第三方应用发放一个访问令牌**，这样就可以在不向第三方应用提供账号和密码的情况下，通过令牌在特定时间内访问用户存放在特定资源服务器上的资源。

比如下面的场景，在Automation cloud的login画面，如下图，有普通的用户名和密码登陆方式，也有google等的登陆方式，其中google等的登陆方式就是采用OAuth2.0协议。

![image](https://user-images.githubusercontent.com/18595935/133916408-d690e6f6-983c-44f7-a34e-c90a2f9b4baf.png)

点击google登陆后，会出现提示授权的信息框，如下图，其URL也转向了 `https://accounts.google.com/o/oauth2/auth/oauthchooseaccount?prompt=select_account&response_type=code&redirect_uri=https%3A%2F%2Faccount.uipath.com%2Flogin%2Fcallback&scope=email%20profile&state=_VRgc_DnnCoz2ByrSLALp3Qtr2MMwE0n&client_id=728299124437-7jehbc7o304f05q191vsc8nuf0g9truf.apps.googleusercontent.com&flowName=GeneralOAuthFlow`

![image](https://user-images.githubusercontent.com/18595935/133916503-f277bcab-63ef-4ff5-91c3-03ee2f1302b5.png)

如果我选择Microsoft，其URL转向了 `https://login.microsoftonline.com/common/oauth2/v2.0/authorize?prompt=select_account&response_type=code&redirect_uri=https%3A%2F%2Faccount.uipath.com%2Flogin%2Fcallback&scope=User.Read%20openid%20email%20profile%20&state=3fBsF9rNTapMzZhltTDiKawXFxwBbcGA&client_id=eb812cb0-7881-44a8-82f7-df95f812e34d`

上面的URL中的信息，应该是提交给google和ms的重定向URL以及访问的scope，以及自身的clientID等。

在Google 和 MS中通过认证后，会发行token，通过token就可以登陆到Automation Cloud了。

# 2. 理解Auth2.0协议

## 协议角色和流程

![image](https://user-images.githubusercontent.com/18595935/133916969-9b8646c0-f320-4aaa-9c89-54fb153ec392.png)

上图中，资源服务器和认证服务器很多时候都是同一个，属于同一个域名，上面的例子中就是google。

![image](https://user-images.githubusercontent.com/18595935/133917062-2d0cd542-857c-4dc5-b91d-3e482adb6ef5.png)

- 上图A和B，分别对应了选择google去login，以及后续的点击同意，同意后得到Resource Owner的授权（允许uipath访问google中的姓名，用户邮件，profile照片等）。
- C，Client即Aumation Cloud，拿着自己的code（ClientID，SecretKey），去向AuthorizationServer请求Access Token。
- D，Authorization Server通过请求后，发行Access Token，有时也会同时附带用户名等。
- E和F，拿到Token后，就可以通过Access Token去Resource Server资源服务器获取需要的信息，比如在Automation Cloud中的user and group中，可以获取到所有用户名，email等信息。













