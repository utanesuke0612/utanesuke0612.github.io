---
layout: post
title: Nano01(自動運転)-U04-Lesson19-Project:Behavioral cloning
date: 2019-01-01 03:04:05
categories: self-driving(自動運転)
tags: self-driving
---
* content
{:toc}

# 3. Project Resources

这个项目通过workspace完成，需要的文件包括：

- drive.py: python脚本，当神经网络训练好了之后进行汽车自动驾驶
- video.py: 当汽车自动驾驶时用于生成video
- sample driving data： `/opt/carnd_p3/data/`中，如果只使用自己的训练数据时，注意将其保存到其他目录
- a simulator

# 4. Running the Simulator

介绍如何使用simulator收集数据：

1. 可以使用键盘key，也可以使用鼠标来控制方向。
2. 使用R录像。

When you first run the simulator, you’ll see a configuration screen asking what size and graphical quality you would like. We suggest running at the smallest size and the fastest graphical quality. 

# 5. Data Collection Tactics(/'tæktɪks/ 策略)

In order to start collecting training data, you'll need to do the following:

- Enter Training Mode in the simulator.
- Start driving the car to get a feel for the controls.
- When you are ready, hit the record button in the top right to start recording.
- Continue driving for a few laps or till you feel like you have enough data.
- Hit the record button in the top right again to stop recording.

# 6. Data Collection Strategies

It's time to think about collecting data that will ensure a successful model. There are a few general concepts to think about that we will later discuss in more detail:

- the car should stay in the center of the road as much as possible
- if the car veers off (突然转向) to the side, it should recover back to center
- driving counter-clockwise (逆时针方向的) can help the model generalize ( /'dʒɛnrəlaɪz/ 一般化)
- flipping(v. 轻弹) the images is a quick way to augment(vt. 增加；/ɔɡ'mɛnt/ ) the data
- collecting data from the second track can also help generalize the model
- we want to avoid overfitting or underfitting when training the model
- knowing when to stop collecting more data

# 7. Data Visualization

如果上面的simulator一切顺利的话：

1. IMG文件夹中，记录了汽车运行的每一帧
2. driving_log.csv，每一行代表汽车运行中的关键数据，比如角度，刹车，速度等。

![image](https://user-images.githubusercontent.com/18595935/52404926-835d2680-2b0d-11e9-892c-bb45e5326989.png)

前三行表示各个摄像头拍下的图片，后面分别是转向角,油门,刹车,速度,转向角的区间是-1到1，油门是0到1。
在这里，我们把这些图像作为特征集，转向角作为标签集，然后用这些数据来训练网络，来预测转向角。

通过使用3张不同角度的图片，能有效的泛化模型。

# 8. Training Your Network

本节介绍了怎么去创建和训练网络，通过Keras训练一个网络完成下面的事情：

1. 将之前拍摄的照片作为神经网络的输入
2. 输出是这个车的转向角

首先通过scp将本地的图片copy到AWS的EC2上,然后在上面提取数据：

```python
scp ~/Desktop/data.zip carnd@35.160.30.126
```

视频中的代码如下：

```python
import csv
import cv2
import numpy as np

lines = []
with open("../data/driving_log.csv") as csvfile:
	reader = csv.reader(csvfile)
	for line in reader:
		lines.append(line)

images = []
measurements = []

# 读取图片和第四行的转向角数据
for line in lines:
	source_path = line[0]
	filename = source_path.split('/')[-1]
	current_path = "../data/IMG" + filename

	image = cv2.imread(current_path)
	images.append(image)

	measurement = float(line[3])
	measurements.append(measurement)

# 上面读取的图片作为输入特征数据，转向角作为标签数据
X_train = np.array(images)
y_train = np.array(measurements)

from keras.models import Sequential
from keras.layers import Flatten,Dense

# 建立keras神经网络
model = Sequential()
model.add(Flatten(input_shape(160,320,3)))
model.add(Dense(1))

# 训练神经网络
model.compile(loss="mse",optimizer="adam")
model.fit(X_train,y_train,validation_split=0.2,shuffle=True,nb_epoch=7)

# 保存好训练的神经网络
model.save("model.h5")
exit()
```

# 9. Running Your Network

现在将训练好的神经网络作为drive.py的输入，运行drive.py后就能为simulator提供转向数据，simulator启动无人驾驶模式后，就能运行起来。

如果这个模型在训练数据和验证数据中的表现都不错(最后的误差函数值小)，那说明是数据收集的有问题，收集的驾驶行为数据应该是车始终在中心校位置。

## 9.1 验证神经网络

在进入上面的simulator之前，需要保证输出的神经网络是好的，一般将数据分为80%的训练数据，20%的验证数据，另外记得要将数据顺序打乱。

**如果训练数据和验证数据中，该神经网络的表现都不好**，即误差函数的值都很高，说明是低度拟合了(underfitting)，需要如下处理：

1. 增加epoch次数
2. 追加更多的卷积层

**如果训练数据中表现不错，但验证数据中表现不好**，说明是过拟合了，需要如下处理：

1. 使用dropout或池化层
2. 使用更少的卷积层或全连接层
3. 收集更多的驾驶数据

理想情况是，在训练数据和验证数据中，神经网络表现都好，这样能保证驾驶时预测到正确的角度。

# 10. Data Preprocessing

1. 将数据数据正规化，保证其在 -0.5 到 0.5 之间
2. 减少epoch为2

```python
# 建立keras神经网络
model = Sequential()
model.add(Lambda(lambda x:(x / 255.0) - 0.5,input_shape=(160,320,3)))

model.add(Flatten(input_shape(160,320,3)))
model.add(Dense(1))
```

Kera中，lambda layer用于生成一个任意函数，在每个图片数据通过该layer时进行处理。

上面例子中的lambda layer将所有的input数据都进行了正规化处理。


# 11. More Networks
