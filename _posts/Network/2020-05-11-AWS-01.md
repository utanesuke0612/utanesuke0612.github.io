---
layout: post
title: AWS：ゼロから実践するAmazon Web Services
date: 2020-05-11 01:00:00
categories: 虚拟化(网络/存储/Cloud)
tags: 云服务
---
* content
{:toc}

> 最近想自己通过python/Django构建一个web服务，其中涉及到infra，考虑过idcf，因为以前用过比较熟悉，但是主流是AWS，以后很多服务都是构建于AWS的，需要掌握AWS的基本用法。
> 
> 这是一个Udemy的课程，参考[AWS：ゼロから実践するAmazon Web Services](https://www.udemy.com/course/aws-and-infra/)
> 

# 1. 使用AWS构建网络和服务器

懂Infra对现在的系统构建很有用处：
1. 可以创建自己的web服务
2. 从系统整体上进行考虑(发生问题时能够切分,考虑对策时不仅能从App层考虑，还能从系统整体去考虑)

构建Infra的时候，网络和服务器通过下面的方式进行构建：
- **服务器构成**
1. 需要什么样的服务器
2. 设置服务器
3. 在服务器上安装OS，进行各种设定
4. 安装需要的软件，并进行设定

- **网络构成**，将构建的服务器连接到网络：
1. 决定网络使用的IP范围
2. 给服务器分配IP地址
3. 给各个IP地址分配域名

下面比较一下オンプレミス和クラウド，日本很多公司喜欢自己构建
服务器，敏感数据是不会放到云上去的。
- **オンプレミス**
1. 自己准备硬件软件，自己进行管理
2. 优点是自由度高
3. 缺点是初期cost高，需要时间，很难对服务器进行增减

- **クラウド**
1. infra通过网络进行管理和使用
2. 优点是，初期cost少，能马上使用，服务器的增减也比较自由
3. 缺点是，费用的预测困难，另外，cloud整体发生故障的话，自己无法对应

# 2. AWS的初期设定

主要完成：

- 注册账号(使用的 lijun.206@gmail.com 账号)
- 使用CloudWatch进行金额监视
- IAM用户的作成(作业用user)
- 使用CloudTrail记录操作log

## 2.1 注册账号

略过，可以有一年的免费试用期间。

## 2.2 金额监视

通过下面的两种方式进行设定:

1. [Billing の設定](https://console.aws.amazon.com/billing/home?#/preferences)
2. [CloudWatch](https://console.aws.amazon.com/cloudwatch/home?region=us-east-1#alarmsV2:)

## 2.3 IAM用户

在AWS的BestPractice中，极力推荐不要使用root user，作业的时候使用IAM user：

- **root user:**
1. 该用户有所有权限
2. 只在账户的解约等时候使用
3. 极力推荐不要使用root user

- **IAM user：**
1. 在AWS内做成的user
2. 可以修改认证信息和访问许可
3. 可以分用户作成
4. 一般的作业使用IAM user

- [设置页面](https://console.aws.amazon.com/iam/home?#/home)
- [LOGIN 用： console](https://336452230265.signin.aws.amazon.com/console)
> 用户名  junli_work


## 2.4 使用CloudTrail记录操作log

- **CloudTrail：**
1. 记录AWS用户操作记录
2. 默认是有效的，保存90天
3. 可以保存到S3，永久保存
4. CloudTrail是免费的，但是S3是收费的

在这里作成：[CloudTrail](https://console.aws.amazon.com/cloudtrail/home?region=us-east-1#/dashboard)

以后log保存在S3这里：[AWSLogs](https://console.aws.amazon.com/s3/buckets/aws-and-infra-junli/AWSLogs/336452230265/CloudTrail/?region=us-east-1#)

# 3. VPC-网络构建

关于网络基本概念，参考以前的一篇总结 [网络基本概念](http://road2ai.info/2017/11/20/network-basic/)

本章包含：
- AWS中的网络
- 决定网络中的IP地址
- 作成VPC
- 作成subnet
- 设置routing
- 网络设计时需要顾虑的方面

本次的例子的网络构成如下：

![image](https://user-images.githubusercontent.com/18595935/81632433-3ae59480-9445-11ea-98ea-b5a43e42d72f.png)

## 3.1 AWS中的网络

1. Region：各个不同的地理区域，现在有近20个Region
2. avilablity zone: 即一个独立的data center，一个Region中包含多个zone
3. VPC：在AWS上可以做成虚拟网络的服务，在VPC做成不同的subnet，比如一个对外的public subnet，一个对内的private subnet

## 3.2 决定网络中的IP地址

- **public IP**
1. 实际与Internet进行连接时使用的IP
2. 为了能够正常通信，IP地址不能重复，IP通过ICANN这个团体统一管理
3. IP地址可以通过provider和server事业提供商提供

- **private IP**
1. 不是在Internet上使用的IP
2. 下面范围的IP可以自由使用：`10.0.0.0 - 10.255.255.255`和`172.16.0.0 - 172.31.255.255`和`192.168.0.0 - 192.168.255.255`
3. 内网构筑等时使用private IP

网络构筑时，需要决定这段网络所要使用的IP地址，IP地址分为`network部`和`host部`：
比如，`192.168.128.0 - 192.168.128.255`的256个IP地址，其中：
- network部：`192.168.128`，即`11000000 10101000 10000000`
- host部：`00000000 - 11111111`这个范围

上面可以通过：`192.168.128.0/24`这样表示，表示前面24位是network部。

本次构建的网络IP如下：

![image](https://user-images.githubusercontent.com/18595935/81693180-81191300-949a-11ea-9fb2-b8b21b148501.png)

## 3.3 构建VPC

下面部分要完成的工作如下：

![image](https://user-images.githubusercontent.com/18595935/81693358-bde50a00-949a-11ea-9d91-8aca89830526.png)

[VPC](https://ap-northeast-1.console.aws.amazon.com/vpc/home?region=ap-northeast-1#dashboard:)

虽然有默认的VPC，但是基本不用，需要重新建立VPC，按照下面的定义创建一个VPC：

![image](https://user-images.githubusercontent.com/18595935/81693918-a0647000-949b-11ea-851a-fbe529e3f797.png)

## 3.4 创建subnet

参考上图的第2部，构建两个subnet：
1. public subnet `10.0.10.0/24`
2. private subnet `10.0.20.0/24`

参考 [subnet](https://ap-northeast-1.console.aws.amazon.com/vpc/home?region=ap-northeast-1#subnets:sort=SubnetId)

创建方式如下：

![image](https://user-images.githubusercontent.com/18595935/81694877-d48c6080-949c-11ea-84f2-ffaa17c86fd8.png)

通过同样的方式创建`aws-and-infra-private-subnet-1a`的subnet `10.0.20.0/24`

## 3.5 【重要】设定routing

为了能将public internet连接上外网，需要进行routing设定。
参考上面的图，有两个task:
1. 创建 internet gateway，并将其与VPC进行关联
2. 创建 route table

上面的两个操作，都在VPC页面进行，具体的操作步骤不复述了，参考这个[视频](https://www.udemy.com/course/aws-and-infra/learn/lecture/15046680#overview)。

# 4. EC2-web服务器构建

# 5. Route53-域名登录

# 6. RDS-DB服务器构建

# 7. EC2-WordPress构建

# 8. S3-CloudFront-分发图片

# 9. ELB-Web层的冗长化

# 10. RDS-DB层的冗长化

# 11. IAM-访问权限管理

# 12. 其他
